# Датасет рецептов
Презентация не влезла в GitHub по какой-то причине, поэтому вот ссылка: https://docs.google.com/presentation/d/1V1cTlY_J8hPdvxwXNdDwsOGGtI1A01td/edit?usp=sharing&ouid=100889452780382132795&rtpof=true&sd=true
## Описание предметной области

Цель: Создать модель, которая может анализировать процесс приготовления блюда в реальном времени, давать подсказки, оценивать успешность выполнения этапов и отвечать на вопросы пользователя.

Зачем нужны данные: чтобы можно было соотносить шаги происходящие на видео с текстовым рецептом.

## Источник данных

ИСточник данных - сайт: [EdaVideo](https://eda.video/).

## Уровни разметки мультимодального кулинарного датасета

| Уровень разметки               | Тип разметки            | Модальность     | Формат    | Инструмент разметки   | Ключи для связей                                    |
| :----------------------------- | :---------------------- | :-------------- | :-------- | :-------------------- | :-------------------------------------------------- |
| **Метаданные рецепта**         | Атрибуты, классификация | Текст           | JSON      | Ручной ввод / Парсинг | `recipe_id`                                         |
| **Сегментация видео на шаги**  | Временные отрезки       | Видео           | JSON      | CVAT, Label Studio    | `recipe_id`, `step_id`, `start_time`, `end_time`    |
| **Детекция продуктов на шаге** | Bounding Box / Маска    | Видео (кадры)   | COCO JSON | CVAT, Scale AI        | `recipe_id`, `step_id`, `image`, `ingredient_id` |
| **Действия на шаге**           | Классификация           | Видео (отрезки) | JSON      | CVAT, Label Studio    | `recipe_id`, `step_id`, `start_time`, `end_time`    |
| **Текстовая инструкция шага**  | Структурированный текст | Текст           | JSON      | Ручной ввод           | `recipe_id`, `step_id`                              |
| **Список продуктов рецепта**   | Структурированный текст | Текст           | JSON      | Ручной ввод           | `recipe_id`, `ingredient_id`                        |

## Граф знаний

![Visualisation](.//quick_rdf_visualization.png)

Здесь каждый шаг и рецепт связан с ингредиентами используемыми в нем. Каждый рецепт связан с его шагами. Так же к каждому шагу добавлен отрезок видео и главная фотография. Каждый рецепт так же содержит ссылку на видео.

## Примеры заполнения

### Ингредиенты

| id | name | lemma |
|----|------|-------|
| 327 | Растительное масло | масло |
| 328 | Говядина | говядина |
| 329 | Лук | лук |
| 330 | Морковь | морковь |
| 331 | Томатная паста | паста |
| 332 | Вода | вода |
| 333 | Соль | соль |
| 334 | Фасоль консервированная | фасоль |
| 335 | Болгарский перец | перец |
| 336 | Картофель | картофель |

### Рецепты

| id | title | url | ingredient_ids | step_ids | video_id | total_steps | total_ingredients | mp4_url | youtube_url | local_video_path |
|----|-------|-----|----------------|----------|----------|-------------|-------------------|---------|-------------|-----------------|
| 35 | * | https://eda.video/uzbekskaia-dymliama | 327\|328\|329\|330\|331\|332\|333\|334\|335\|336\|337\|338\|339 | 499\|500\|501\|502\|503\|504\|505\|506\|507\|508\|509\|510\|511\|512 | 35 | 14 | 13 | https://eda.video/storage/videos/hkaP4I0JwaXIWXT6CpZpBr3UkdNHgvkfrGIeZ0DX.mp4 |  | ./sources/35/vid__35.mp4 |
| 36 | * | https://eda.video/losos-v-slivocnom-souse-na-skovorode | 333\|337\|327\|340\|327\|335\|341\|342\|343\|344\|345 | 513\|514\|515\|516\|517\|518\|519\|520\|521\|522\|523\|524\|525\|526\|527\|528 | 36 | 16 | 11 | https://eda.video/storage/videos/UKM8AEDfhQvwaHZ0CVsaXTL1HswLYSxPOephdbU8.mp4 |  | ./sources/36/vid__36.mp4 |

### Шаги

| id | recipe_id | step_number | step_index | description | tokens | ingredients | image |
|----|-----------|-------------|------------|-------------|--------|-------------|-------|
| 499 | 35 | Шаг 1: | 1 | Залейте растительное масло на дно кастрюли. | ['залить', 'растительный', 'масло', 'дно', 'кастрюля'] | [327] | ./sources/35/1.png |
| 500 | 35 | Шаг 2: | 2 | Нарежьте мясо ка куски среднего размера. | ['нарезать', 'мясо', 'кусок', 'среднее', 'размер'] |  | ./sources/35/2.png |
| 501 | 35 | Шаг 3: | 3 | Выложите мясо в разогретое масло, обжарьте до потемнения. | ['выложить', 'мясо', 'разогреть', 'масло', 'обжарить', 'потемнение'] | [327] | ./sources/35/3.png |
| 502 | 35 | Шаг 4: | 4 | Нарежьте лук и добавьте его в кастрюлю к мясу. | ['нарезать', 'лук', 'добавить', 'кастрюля', 'мясо'] | [329] | ./sources/35/4.png |
| 503 | 35 | Шаг 5: | 5 | Нарежьте морковку на полоски и выложите к луку. Перемешайте. | ['нарезать', 'морковка', 'полоска', 'выложить', 'лук', 'перемешать'] | [329] | ./sources/35/5.png |
| 504 | 35 | Шаг 6: | 6 | Смешайте томатную пасту с водой, перемешайте и залейте в кастрюлю. | ['смешать', 'томатный', 'паста', 'вода', 'перемешать', 'залить', 'кастрюля'] | [331, 332] | ./sources/35/6.png |
| 505 | 35 | Шаг 7: | 7 | Отварите фасоль и добавьте в кастрюлю. Посолите. | ['отварить', 'фасоль', 'добавить', 'кастрюля', 'посолить'] | [334] | ./sources/35/7.png |
| 506 | 35 | Шаг 8: | 8 | Нарежьте болгарский перец и высыпьте поверх фасоли. | ['нарезать', 'болгарский', 'перец', 'высыпать', 'поверх', 'фасоль'] | [334, 335] | ./sources/35/8.png |
| 507 | 35 | Шаг 9: | 9 | Очистите и нарежьте картофель на произвольные куски размером примерно с куски мяса, добавьте в кастрюлю. | ['очистить', 'нарезать', 'картофель', 'произвольный', 'кусок', 'размер', 'примерно', 'кусок', 'мясо', 'добавить', 'кастрюля'] | [336] | ./sources/35/9.png |

### Таймкоды

| step_id | start_time | end_time | start_time_str | end_time_str |
|---------|------------|----------|----------------|--------------|
| 499 | 0 | 3 | 00:00:00 | 00:00:03 |
| 501 | 3 | 28 | 00:00:03 | 00:00:28 |
| 502 | 22 | 24 | 00:00:22 | 00:00:24 |
| 503 | 24 | 32 | 00:00:24 | 00:00:32 |
| 504 | 32 | 37 | 00:00:32 | 00:00:37 |
| 505 | 37 | 55 | 00:00:37 | 00:00:55 |
| 506 | 56 | 60 | 00:00:56 | 00:01:00 |
| 507 | 60 | 70 | 00:01:00 | 00:01:10 |
| 508 | 70 | 74 | 00:01:10 | 00:01:14 |
| 509 | 74 | 77 | 00:01:14 | 00:01:17 |
| 510 | 77 | 97 | 00:01:17 | 00:01:37 |

## Описание работы

### Парсинг

Для парсинга нужен список ссылок на рецепт, все данные собираются с сайта автоматически после запуска последнего блока parser.ipynb, все ингредиенты собираюются в лему и если она совпадает. то мы не добавляем новый ингридиент, а ссылаемся на старый.

[//]: <> (Области роста: лучше за лемму брать не только существительное, но и прилагательное, или стоит придумать какую-то хитрую конструкцию для удаления повторений. И можно добавить автоматический парсер ссылок на страницы рецептов)

Индексы берутся из файла id_state.json для их обновления достаточно его удалить, зато можно парсить по несколько групп сайтов в отрыве друг от друга и это будет тратить меньше времени.

Данные рецептов и шагов сохраняются в файл с припиской "_raw", это указывает на то, что они будут дорабатываться в следующем пункте.

### Загрузчик

Следующий файл download_imagesvideos.ipnb, не смотря на то что так называется выполняет еще и связывание шагов рецептов с ингрилиентами на котором они используются и токенизацию текста шагов рецептов. Мы убираем стоп слова с посощью nltk и лемматизируем через pymorphy3.

Чтобы определить какие слова использовались в каких шагах мы соотносим все лемы шага с лемами ингредиентов.

Последний блок в этом файле был добавлен для отделения таймкодов, к сожалению это происходит вручную. Хоть я и постарался это максимально оптимизировать. Перед вами открывается запрос со временем начала отрезка, который так же описан в этом запросе. Вы открываете видео указанное в запросе пишите время начала и время конца отрезка, если идти подряд, то началом следующего отрезка будет считаться конец текущего. Время можно вводить втрех форматах hh:mm:ss, mm:ss, ss.

